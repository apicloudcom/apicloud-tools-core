!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("fs-extra"),require("path"),require("prompt"),require("ws"),require("events"),require("glob"),require("os"),require("http"));else if("function"==typeof define&&define.amd)define(["fs-extra","path","prompt","ws","events","glob","os","http"],t);else{var n="object"==typeof exports?t(require("fs-extra"),require("path"),require("prompt"),require("ws"),require("events"),require("glob"),require("os"),require("http")):t(e["fs-extra"],e.path,e.prompt,e.ws,e.events,e.glob,e.os,e.http);for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(this,function(e,t,n,o,r,i,a,c){return function(e){function t(o){if(n[o])return n[o].exports;var r=n[o]={exports:{},id:o,loaded:!1};return e[o].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){(function(e){"use strict";function o(e){if(null==e)throw new TypeError("Cannot destructure undefined")}Object.defineProperty(t,"__esModule",{value:!0});var r=n(2),i=n(3),a=n(4),c=n(5),s="../file_template",l="../app_template",u=n(11),p=n(12),d={appTemplateConfig:function(){return p},fileTemplateConfig:function(){return u},startWifi:function(e){var t=e.port,n=void 0===t?8686:t,o=e.host,r=void 0===o?"0.0.0.0":o;return c.start({port:n,host:r})},endWifi:function(e){return o(e),c.end({})},syncWifi:function(e){var t=e.projectPath,n=e.syncAll;return c.sync({project:t,updateAll:n})},previewWifi:function(e){var t=e.file;return t&&""!==t?c.preview({file:t}):void console.error("预览路径不能为空!")},wifiInfo:function e(){var e={ip:c.localIp(),port:c.port,clientsCount:c.clientsCount};return e},wifiLog:function(e){return new Promise(function(t){c.on("log",function(n){e(n),t()})})},init:function(e){var t=e.name,n=e.template,o=e.output;if(t+="",n+="",o+="",!p[n])return void console.error("不支持的模板类型:"+n+" 可选模板: "+Object.keys(p));this.validatePackageName(t);var a=i.resolve(o,t);r.existsSync(a)?this.createAfterConfirmation(t,n,o):this.createProject(t,n,o)},addFileTemplate:function(e){var t=e.name,n=e.output,o=e.template;t+="",n+="",o+="";var a=u[o];if(!a)return void console.error("找不到页面框架模板:"+o+",目前支持的页面模板为:"+Object.keys(u));var c=i.resolve(n),l=i.resolve(n,"config.xml");if(!r.existsSync(c)||!r.existsSync(l))return void console.error(c+" 不是一个有效的APICloud项目!");try{var p=i.join(__dirname,s,a);r.walk(p).on("data",function(e){var n=e.path,o=e.stats,a=i.relative(p,n),s=i.resolve(c,a),l=i.dirname(s);if(!o.isDirectory()){var u=i.basename(s);if(u=u.replace(/apicloudFrame|apicloudWindow(?=\.html)/g,function(e){var n={apicloudFrame:t+"_frame",apicloudWindow:t+"_window"};return n[e]}),s=i.resolve(l,u),r.copySync(n,s,{filter:function(){return!/^[.]+/.test(u)}}),/\.html$/.test(u)){var d=r.readFileSync(s,"utf8");d=d.replace(/apicloudFrame|apicloudWindow/g,function(e){var n={apicloudFrame:t+"_frame",apicloudWindow:t+"_window"};return n[e]}),r.writeFileSync(s,d)}}}).on("end",function(){})}catch(e){return void console.error("创建 APICloud 页面框架失败: "+e)}},validatePackageName:function(e){if(!e.match(/^[\w]{1,20}$/i))return void console.error('"%s" 应用名称无效. 应用名称应在20个字符以内,且不能包含空格和符号!',e)},createAfterConfirmation:function(e,t,n){var o=this;a.start();var r={name:"yesno",message:"目录 "+i.resolve(n,e)+" 已存在. 是否继续?",validator:/[是|否]+/,warning:"必须回复 是 或 否",default:"否"};a.get(r,function(r,i){"是"===i.yesno&&o.createProject(e,t,n)})},createProject:function(e,t,n){var o=i.resolve(n,e);r.existsSync(o)||r.mkdirSync(o);try{var a=i.join(__dirname,l,t);r.copySync(a,o);var c=i.join(o,"config.xml"),s=r.readFileSync(c,"utf8");return s=s.replace(/\<name\>.*\<\/name\>/g,"<name>"+e+"</name>"),void r.writeFileSync(c,s,"utf8")}catch(e){return void console.error("创建APICloud项目失败:"+e)}}};t.default=d,e.exports=d,e.export=d}).call(t,n(1)(e))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("prompt")},function(e,t,n){"use strict";function o(e){if(null==e)throw new TypeError("Cannot destructure undefined")}var r=n(6).Server,i=n(3),a=n(2),c=n(7),s=-1,l=n(8),u={port:null,socketServer:null,workspace:null,httpServer:null,fileListSynced:{},clientsCount:0,emitter:new c,localIp:function(){var e=n(9),t=e.networkInterfaces(),o=[];for(var r in t)t[r].forEach(function(e,t){"IPv4"===e.family&&"127.0.0.1"!==e.address&&o.push(e.address)});return o},start:function(e){var t=this,o=e.port,c=void 0===o?8686:o,s=e.host,l=void 0===s?"0.0.0.0":s,u=n(10).createServer(function(e,n){var o=e.url,r=o.match(/^\/([^\/]+)/);if(!r)return void t.notFound({res:n});var c=r[1];t.projectPath({appId:c,workspace:t.workspace}).then(function(e){if(!e)return void t.notFound({res:n});var r=i.relative("/"+c,o),s=i.resolve(e,r);return!a.existsSync(s)||a.lstatSync(s).isDirectory()?void t.notFound({res:n}):(t.fileListSynced[c]||(t.fileListSynced[c]={}),t.fileListSynced[c][s]||(t.fileListSynced[c][s]=!0),void a.createReadStream(s).pipe(n))})}),p=new r({server:u});this.port=c,this.socketServer=p,this.httpServer=u,p.on("connection",function(e){t.handleConnection({socket:e})}),u.listen(c,l,function(){console.log("APICloud Is Listening on ip: "+u.address().address+" port: "+u.address().port+")")})},end:function(e){o(e),this.socketServer.close(),this.httpServer.close(),console.log("APICloud Wifi 真机同步服务 已关闭...")},handleConnection:function(e){var t=this,n=e.socket;++this.clientsCount,console.log("connection"),console.log("当前连接设备数:"+this.clientsCount),n.send(JSON.stringify({command:7,port:this.port})),n.on("error",function(e){}),n.on("close",function(){console.log("disconnected"),--t.clientsCount,console.log("当前连接设备数:"+t.clientsCount)}),n.on("message",function(e){var o=JSON.parse(e);if(s===o.command){var r=o.payload;r=r||{},r.params.socket=n,t.handleCli(r)}if(4===o.command){var i=t.replyLoaderHeartbeatCmd({command:o.command});t.sendCommand({socket:n,cmd:i})}5===o.command&&heartbeatTimes--,2===o.command&&t.fileListCmd({appId:o.appid,timestamp:o.timestamp,workspace:t.workspace}).then(function(e){t.sendCommand({socket:n,cmd:e})}),8===o.command&&t.handleLog({cmd:o})})},sync:function(e){var t=e.project,n=e.updateAll;if("string"!=typeof t)return void console.log(t+" 不是一个有效的文件路径");var o=i.resolve(t),r=i.resolve(o,"config.xml"),c=i.resolve(o,".."),s=null;if(a.existsSync(r)){var l=a.readFileSync(r,"utf8"),u=l.match(/widget.*id.*=.*(A[0-9]{13})\"/);u&&(s=u[1])}if(!s)return void console.log(t+" 似乎不是一个有效的APICloud项目");this.workspace=c;var p=this.syncCmd({appId:s,updateAll:n});this.broadcastCommand({socketServer:this.socketServer,cmd:p})},preview:function(e){var t=e.file;if("string"!=typeof t)return void console.log(t+" 不是一个有效的文件路径");t=i.resolve(t);for(var n=i.resolve(t,".."),o=null,r=null;!0;){if(o=i.resolve(n,"config.xml"),a.existsSync(o)){var c=a.readFileSync(o,"utf8"),s=c.match(/widget.*id.*=.*(A[0-9]{13})\"/);s&&(r=s[1]);break}if(n===i.resolve("/"))break;n=i.resolve(n,"..")}if(!r)return void console.log(t+" 似乎不在有效的APICloud项目中");this.workspace=i.resolve(n,"..");var l=this.previewCmd({file:t,workspace:this.workspace,appId:r});this.broadcastCommand({socketServer:this.socketServer,cmd:l})},broadcastCommand:function(e){var t=this,n=e.socketServer,o=e.cmd;n.clients.forEach(function(e){t.sendCommand({socket:e,cmd:o})})},sendCommand:function(e){var t=e.socket,n=e.cmd,o=JSON.stringify(n);t.send(o,function(e){})},handleLog:function(e){var t=e.cmd;this.emitter.emit("log",{content:t.content,level:t.level})},on:function(e,t){console.log("on:"+JSON.stringify(e)),this.emitter.on(e,t)},syncCmd:function(e){var t=e.appId,n=e.updateAll,o=void 0===n||n;return{command:1,appid:t,updateAll:o}},globMatch:function(e){var t=e.project,n=e.sync,o=void 0===n?".syncignore":n,r=i.resolve(t,o),c=a.existsSync(r)&&a.readFileSync(r,{encoding:"utf8"})||"",s=l.sync("**",{nodir:!0,ignore:c,realpath:!0,cwd:t});return s},fileListCmd:function(e){var t=this,n=e.appId,o=e.timestamp,r=void 0===o?0:o,i=e.workspace;return new Promise(function(e){t.projectPath({appId:n,workspace:i}).then(function(o){var c=t.globMatch({project:o})||[];c=c.filter(function(e){var o=a.statSync(e),i=o.mtime,c=t.fileListSynced[n];return i.getTime()/1e3>r||!(c&&c[e])}).map(function(e){return t.absoluteUrlPath({file:e,workspace:i,appId:n})}),e({command:3,list:c,timestamp:Math.floor(Date.now()/1e3)})})})},replyLoaderHeartbeatCmd:function(e){var t=e.command;return{command:t}},previewCmd:function(e){var t=e.file,n=e.workspace,o=e.appId,r=this.absoluteUrlPath({file:t,workspace:n,appId:o});return{command:6,path:r,appid:o}},httpPortCmd:function(e){var t=e.port;return{command:7,port:t}},absoluteUrlPath:function e(t){var n=t.file,o=t.workspace,r=t.appId,a=i.relative(o,n);a=a.replace(/\\/g,"/");var e="/"+a.replace(/^[^\/]*/,r);return e},projectPath:function e(t){var n=t.appId,o=t.workspace,e=null;return new Promise(function(t){a.walk(o,{filter:function(e){return i.resolve(o)===i.resolve(e,"./..")}}).on("data",function(e){var o=e.path,r=e.stats,c=i.join(o,"config.xml");if(r.isDirectory()&&a.existsSync(c)){var s=a.readFileSync(c,"utf8"),l=s.match(/widget.*id.*=.*(A[0-9]{13})\"/);l&&n===l[1]&&t(o)}}).on("end",function(){t(e)})})},notFound:function(e){var t=e.res;t.writeHead(404,{"Content-Type":"text/plain"}),t.write("404 Not found"),t.end()},handleCli:function(e){var t=e.method,n=e.params,o=n.socket;"function"==typeof p[t]?p[t](n):(console.log("不支持的方法: "+t),o.close())}},p={wifiSync:function(e){var t=e.project,n=void 0===t?"./":t,o=e.updateAll,r=void 0===o||o,i=e.socket;u.sync({project:n,updateAll:r}),i.close()},wifiStop:function(e){e.socket;u.end({})},wifiPreview:function(e){var t=e.file,n=e.socket;u.preview({file:t}),n.close()},wifiInfo:function e(t){var n=t.socket,e={ip:u.localIp(),port:u.port,clientsCount:u.clientsCount},o={command:s,payload:e};u.sendCommand({socket:n,cmd:o}),n.close()},wifiLog:function(e){var t=e.socket;u.on("log",function(e){var n={command:s,payload:e};u.sendCommand({socket:t,cmd:n})})}};e.exports=u},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("glob")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("http")},function(e,t){e.exports={page001:"dianping-classify",page002:"dianping-group",page003:"dianping-home",page004:"dianping-info",page005:"dianping-merchant",page006:"dianping-mine",page007:"dianping-movie",page008:"dianping-orderDetail",page009:"souhu-hot",page010:"souhu-recommend",page011:"tianmao-home",page012:"tianmao-mine",page013:"tianmao-shopping",page014:"wangyimusic-down",page015:"elema-1",page016:"elema-2",page017:"qiushibaike",page018:"qq-movie-1",page019:"qq-movie-2",page020:"tuniu-1",page021:"tuniu-2",page022:"wangyi-music",page023:"wangyi-news-1",page024:"wangyi-news-2",page025:"wangyi-news-3",page026:"wangyi-news-4"}},function(e,t){e.exports={default:"空白应用",bottom:"底部导航",home:"首页导航",slide:"侧边导航"}}])});